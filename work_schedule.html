<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>סידור עבודה שבועי</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      padding: 12px;
      min-height: 100vh;
      color: #2c3e50;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      margin-bottom: 12px;
    }
    .header h1 {
      font-size: 18px;
      text-align: center;
      margin-bottom: 10px;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .badge.manager { background: linear-gradient(135deg,#f093fb 0%,#f5576c 100%); }
    .badge.admin { background: linear-gradient(135deg,#30cfd0 0%,#330867 100%); }
    .info {
      background: linear-gradient(135deg,#e0f7fa 0%,#b2ebf2 100%);
      border-right: 4px solid #00acc1;
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.3;
    }
    .week-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      font-size: 12px;
      white-space: nowrap;
      text-decoration: none;
    }
    .btn.secondary {
      background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      color: #0b2b36;
    }
    .week-title {
      flex: 1;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      color: #2c3e50;
      min-width: 220px;
    }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border: 1px solid #e5e5e5; padding: 8px 6px; text-align: center; vertical-align: top; }
    th {
      color: #fff;
      font-weight: 700;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      font-size: 11px;
    }
    .name-cell { font-weight: 700; background: #f3f5f7; }
    .name-cell.current-user { background: #e8f5e9; border-right: 3px solid #4caf50; }
    .cell {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 86px;
    }
    select, input {
      width: 100%;
      border: 2px solid #cfd6dd;
      border-radius: 8px;
      padding: 6px;
      font-size: 12px;
      background: #fff;
    }
    select:disabled, input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .pill {
      border-radius: 10px;
      padding: 6px;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
    }
    .pill.office { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .pill.home1  { background: linear-gradient(135deg,#f093fb 0%,#f5576c 100%); }
    .pill.home2  { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color:#0b2b36; }
    .pill.vacation { background: linear-gradient(135deg,#fa709a 0%,#fee140 100%); color:#2c3e50; }
    .pill.other { background: linear-gradient(135deg,#30cfd0 0%,#330867 100%); }

    .meta {
      font-size: 10px;
      color: #6b7785;
      background: #f7f9fb;
      border: 1px solid #e6edf3;
      border-radius: 8px;
      padding: 5px 6px;
      line-height: 1.25;
      min-height: 28px;
      white-space: pre-line;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
    }
    .overlay .box {
      background: #fff;
      border-radius: 14px;
      padding: 18px 16px;
      width: min(420px, 100%);
      text-align: center;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
    }
    .overlay .msg { font-weight: 800; margin-bottom: 10px; }
  </style>
</head>

<body>
  <div class="card header">
    <h1>סידור עבודה שבועי</h1>
    <div class="row">
      <div>
        <strong>מחובר:</strong> <span id="currentUser">-</span>
        <span class="badge" id="roleBadge">עובד</span>
      </div>
      <div>
        <a href="index.html" class="btn secondary" style="padding: 5px 10px; font-size: 11px;">החלף משתמש</a>
      </div>
      <div id="currentDate">-</div>
    </div>
  </div>

  <div class="card info" id="infoMessage">
    כולם יכולים לעדכן את הסידור ישירות. אין אישורים. כל שינוי נשמר מיד.
  </div>

  <div class="card week-nav">
    <button class="btn" id="btnPrev">שבוע קודם</button>
    <div class="week-title" id="weekTitle">טוען...</div>
    <button class="btn" id="btnNext">שבוע הבא</button>
    <button class="btn secondary" id="btnRefresh">רענן</button>
  </div>

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:110px;">עובד</th>
          <th id="h0">א'</th>
          <th id="h1">ב'</th>
          <th id="h2">ג'</th>
          <th id="h3">ד'</th>
          <th id="h4">ה'</th>
        </tr>
      </thead>
      <tbody id="scheduleBody"></tbody>
    </table>
  </div>

  <div class="overlay" id="overlay">
    <div class="box">
      <div class="msg" id="overlayMsg">טוען...</div>
      <div>אנא המתן</div>
    </div>
  </div>

  <script>
    // =====================================================
    // הגדרות - עדכן את ה-API_URL לכתובת ה-web app שלך!
    // =====================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwbMksqij9FM59tIwlrIz0350R6sKn6z1-dHWy-RqBou6CgSxVDtSNltaXB_veUH2pHIQ/exec";

    // רשימת העובדים - מופיעים בטבלה
    const EMPLOYEES = {
      emp1: { name: "יוסי מזרחי", department: "general" },
      emp2: { name: "מיכל דהן", department: "general" },
      emp3: { name: "אבי שמש", department: "general" },
      emp4: { name: "נועה ברק", department: "general" },
      emp5: { name: "עומר גולן", department: "general" }
    };

    // רשימת כל המשתמשים (כולל מנהלים)
    const ALL_USERS = {
      emp1: { name: "יוסי מזרחי", role: "employee" },
      emp2: { name: "מיכל דהן", role: "employee" },
      emp3: { name: "אבי שמש", role: "employee" },
      emp4: { name: "נועה ברק", role: "employee" },
      emp5: { name: "עומר גולן", role: "employee" },
      manager1: { name: "דני כהן", role: "manager" },
      manager2: { name: "שרה לוי", role: "manager" },
      dept_manager: { name: "רונית אברהם", role: "dept_manager" },
      admin: { name: "מנהל מערכת", role: "admin" }
    };

    const WORK_OPTIONS = [
      { value: "", label: "-- בחר --" },
      { value: "office", label: "משרד" },
      { value: "home1", label: "בית 1" },
      { value: "home2", label: "בית 2" },
      { value: "vacation", label: "חופש" },
      { value: "other", label: "אחר" }
    ];

    const DAYS = ["sunday", "monday", "tuesday", "wednesday", "thursday"];
    const DAY_NAMES = ["א'", "ב'", "ג'", "ד'", "ה'"];

    let currentWeekOffset = 0;
    let scheduleData = {};
    const otherDebounceTimers = new Map();

    // משתמש נוכחי - נקרא מה-URL
    let currentUserKey = "";
    let currentUserName = "";
    let currentUserRole = "employee";

    // =====================================================
    // קריאת פרמטרים מה-URL
    // =====================================================
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        user: params.get("user") || "",
        name: params.get("name") || "",
        role: params.get("role") || "employee"
      };
    }

    function initCurrentUser() {
      const params = getUrlParams();
      
      if (params.user && ALL_USERS[params.user]) {
        currentUserKey = params.user;
        currentUserName = ALL_USERS[params.user].name;
        currentUserRole = params.role || ALL_USERS[params.user].role || "employee";
      } else if (params.user && params.name) {
        currentUserKey = params.user;
        currentUserName = params.name;
        currentUserRole = params.role || "employee";
      } else {
        // אם אין פרמטרים - חזור לדף הבחירה
        window.location.href = "index.html";
        return false;
      }

      document.getElementById("currentUser").textContent = currentUserName;
      
      // עדכון ה-badge לפי התפקיד
      const badge = document.getElementById("roleBadge");
      if (currentUserRole === "admin") {
        badge.textContent = "מנהל מערכת";
        badge.className = "badge admin";
      } else if (currentUserRole === "dept_manager") {
        badge.textContent = "מנהל/ת אגף";
        badge.className = "badge manager";
      } else if (currentUserRole === "manager") {
        badge.textContent = "מנהל/ת";
        badge.className = "badge manager";
      } else {
        badge.textContent = "עובד/ת";
        badge.className = "badge";
      }

      return true;
    }

    // =====================================================
    // בדיקת הרשאות עריכה
    // =====================================================
    function canEdit(empKey) {
      // מנהל מערכת ומנהל אגף יכולים לערוך את כולם
      if (currentUserRole === "admin" || currentUserRole === "dept_manager") {
        return true;
      }
      // מנהל יכול לערוך את כולם
      if (currentUserRole === "manager") {
        return true;
      }
      // עובד יכול לערוך רק את עצמו
      return currentUserKey === empKey;
    }

    // =====================================================
    // פונקציות עזר
    // =====================================================
    function showOverlay(msg) {
      document.getElementById("overlayMsg").textContent = msg;
      document.getElementById("overlay").style.display = "flex";
    }
    function hideOverlay() {
      document.getElementById("overlay").style.display = "none";
    }

    function getWeekDates(offset) {
      const today = new Date();
      const sunday = new Date(today);
      sunday.setDate(today.getDate() - today.getDay() + (offset * 7));
      const dates = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(sunday);
        d.setDate(sunday.getDate() + i);
        dates.push(d);
      }
      return dates;
    }

    function formatDate(d) {
      return d.getDate() + "/" + (d.getMonth() + 1);
    }

    function getWeekKey(offset) {
      const dates = getWeekDates(offset);
      const s = dates[0];
      return s.getFullYear() + "-" + (s.getMonth() + 1) + "-" + s.getDate();
    }

    function updateHeaders() {
      const dates = getWeekDates(currentWeekOffset);
      for (let i = 0; i < 5; i++) {
        const ds = formatDate(dates[i]);
        const th = document.getElementById("h" + i);
        th.innerHTML = DAY_NAMES[i] + "<div style='font-size:10px;font-weight:400;opacity:.9'>" + ds + "</div>";
      }
    }

    function updateWeekTitle() {
      const dates = getWeekDates(currentWeekOffset);
      const start = formatDate(dates[0]);
      const end = formatDate(dates[4]);
      let title = "";
      if (currentWeekOffset === 0) title = "השבוע הנוכחי (" + start + " - " + end + ")";
      else if (currentWeekOffset === 1) title = "שבוע הבא (" + start + " - " + end + ")";
      else if (currentWeekOffset === -1) title = "שבוע שעבר (" + start + " - " + end + ")";
      else if (currentWeekOffset > 1) title = "בעוד " + currentWeekOffset + " שבועות (" + start + " - " + end + ")";
      else title = "לפני " + Math.abs(currentWeekOffset) + " שבועות (" + start + " - " + end + ")";
      document.getElementById("weekTitle").textContent = title;
    }

    function updateCurrentDate() {
      document.getElementById("currentDate").textContent = new Date().toLocaleDateString("he-IL");
    }

    // =====================================================
    // ניהול נתונים
    // =====================================================
    function ensureWeekData() {
      const wk = getWeekKey(currentWeekOffset);
      if (!scheduleData[wk]) scheduleData[wk] = {};
      Object.keys(EMPLOYEES).forEach(ek => {
        if (!scheduleData[wk][ek]) scheduleData[wk][ek] = {};
        DAYS.forEach(day => {
          if (!scheduleData[wk][ek][day]) {
            scheduleData[wk][ek][day] = { type: "", other: "", updated_at: "", updated_by_name: "" };
          }
        });
      });
      return scheduleData[wk];
    }

    // =====================================================
    // API
    // =====================================================
    async function apiGet(paramsObj) {
      const params = new URLSearchParams(paramsObj);
      const url = API_URL + "?" + params.toString();
      const res = await fetch(url, { method: "GET" });
      return await res.json();
    }

    async function apiPost(action, payload) {
      const url = API_URL + "?action=" + encodeURIComponent(action);
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return await res.json();
    }

    function getAny(obj, keys) {
      for (let i = 0; i < keys.length; i++) {
        const k = keys[i];
        if (obj && obj[k] != null && obj[k] !== "") return obj[k];
      }
      return "";
    }

    function convertServerToWeekData(requests) {
      const weekData = ensureWeekData();

      (requests || []).forEach(r => {
        const empKey = r.employee_key || r.employeeKey;
        const dayKey = r.day_key || r.dayKey;
        if (!empKey || !dayKey) return;
        if (!weekData[empKey] || !weekData[empKey][dayKey]) return;

        const updatedAt =
          getAny(r, ["updated_at", "updatedAt", "updated_time", "updatedTime", "last_updated", "lastUpdated"]) ||
          getAny(r, ["created_at", "createdAt", "create_time", "createTime"]);

        const updatedByName = getAny(r, ["updated_by_name", "updatedByName"]) || "";

        weekData[empKey][dayKey] = {
          type: getAny(r, ["choice_value", "choiceValue"]) || "",
          other: getAny(r, ["choice_other", "choiceOther"]) || "",
          updated_at: updatedAt || "",
          updated_by_name: updatedByName
        };
      });
    }

    async function loadWeekFromServer() {
      try {
        showOverlay("טוען נתונים...");
        const weekKey = getWeekKey(currentWeekOffset);

        const data = await apiGet({
          action: "loadWeek",
          week_key: weekKey
        });

        if (!data || data.success !== true) {
          throw new Error((data && (data.error || data.message)) ? (data.error || data.message) : "שגיאה בטעינה");
        }

        const wk = getWeekKey(currentWeekOffset);
        scheduleData[wk] = {};
        ensureWeekData();

        convertServerToWeekData(data.requests || []);
        hideOverlay();
        return true;
      } catch (e) {
        hideOverlay();
        alert("שגיאה בטעינת נתונים: " + (e && e.message ? e.message : e));
        return false;
      }
    }

    // =====================================================
    // רינדור הטבלה
    // =====================================================
    function workLabel(type, other) {
      const opt = WORK_OPTIONS.find(o => o.value === type);
      if (type === "other" && other) return other;
      return opt ? opt.label : "";
    }

    function pillClass(type) {
      if (type === "office") return "pill office";
      if (type === "home1") return "pill home1";
      if (type === "home2") return "pill home2";
      if (type === "vacation") return "pill vacation";
      return "pill other";
    }

    function formatMeta(updatedAtIso, updatedByName) {
      if (!updatedAtIso && !updatedByName) return "טרם עודכן";
      const line1 = updatedByName ? ("עודכן על ידי: " + updatedByName) : "עודכן";
      let line2 = "";
      if (updatedAtIso) {
        try {
          const d = new Date(updatedAtIso);
          line2 = "בתאריך: " + d.toLocaleString("he-IL");
        } catch (_) {
          line2 = "בתאריך: " + updatedAtIso;
        }
      }
      return line2 ? (line1 + "\n" + line2) : line1;
    }

    function renderTable() {
      const weekData = ensureWeekData();
      const tbody = document.getElementById("scheduleBody");
      tbody.innerHTML = "";

      const frag = document.createDocumentFragment();

      Object.keys(EMPLOYEES).forEach(empKey => {
        const tr = document.createElement("tr");
        const isCurrentUser = (empKey === currentUserKey);
        const editable = canEdit(empKey);

        const tdName = document.createElement("td");
        tdName.className = "name-cell" + (isCurrentUser ? " current-user" : "");
        tdName.textContent = EMPLOYEES[empKey].name + (isCurrentUser ? " (אני)" : "");
        tr.appendChild(tdName);

        DAYS.forEach(dayKey => {
          const cellData = weekData[empKey][dayKey];
          const td = document.createElement("td");

          const wrap = document.createElement("div");
          wrap.className = "cell";

          if (cellData.type) {
            const pill = document.createElement("div");
            pill.className = pillClass(cellData.type);
            pill.textContent = workLabel(cellData.type, cellData.other);
            wrap.appendChild(pill);
          }

          const sel = document.createElement("select");
          sel.dataset.action = "type";
          sel.dataset.emp = empKey;
          sel.dataset.day = dayKey;
          sel.disabled = !editable;

          WORK_OPTIONS.forEach(opt => {
            const o = document.createElement("option");
            o.value = opt.value;
            o.textContent = opt.label;
            if (cellData.type === opt.value) o.selected = true;
            sel.appendChild(o);
          });

          wrap.appendChild(sel);

          const otherInput = document.createElement("input");
          otherInput.type = "text";
          otherInput.placeholder = "פרט...";
          otherInput.dataset.action = "other";
          otherInput.dataset.emp = empKey;
          otherInput.dataset.day = dayKey;
          otherInput.value = cellData.other || "";
          otherInput.style.display = (cellData.type === "other") ? "block" : "none";
          otherInput.disabled = !editable;
          wrap.appendChild(otherInput);

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = formatMeta(cellData.updated_at, cellData.updated_by_name);
          wrap.appendChild(meta);

          td.appendChild(wrap);
          tr.appendChild(td);
        });

        frag.appendChild(tr);
      });

      tbody.appendChild(frag);
    }

    // =====================================================
    // שמירת תא
    // =====================================================
    function clearOtherDebounce(empKey, dayKey) {
      const k = empKey + "|" + dayKey;
      const t = otherDebounceTimers.get(k);
      if (t) clearTimeout(t);
      otherDebounceTimers.delete(k);
    }

    function setOtherDebounce(empKey, dayKey, fn, ms) {
      clearOtherDebounce(empKey, dayKey);
      const k = empKey + "|" + dayKey;
      otherDebounceTimers.set(k, setTimeout(fn, ms));
    }

    async function saveCell(empKey, dayKey) {
      const weekData = ensureWeekData();
      const cell = weekData[empKey][dayKey];

      const payload = {
        employee_key: empKey,
        employee_name: EMPLOYEES[empKey].name,
        department: EMPLOYEES[empKey].department || "general",
        week_key: getWeekKey(currentWeekOffset),
        day_key: dayKey,
        choice_value: cell.type || "",
        choice_other: cell.other || "",
        updated_by: currentUserKey,
        updated_by_name: currentUserName
      };

      try {
        showOverlay("שומר...");
        const data = await apiPost("upsertCell", payload);
        if (!data || data.success !== true) {
          throw new Error((data && (data.error || data.message)) ? (data.error || data.message) : "שגיאה בשמירה");
        }

        const nowIso = new Date().toISOString();
        cell.updated_at = nowIso;
        cell.updated_by_name = currentUserName;

        hideOverlay();
        renderTable();
      } catch (e) {
        hideOverlay();
        alert("שגיאה בשמירה: " + (e && e.message ? e.message : e));
      }
    }

    function onTableChange(e) {
      const t = e.target;
      if (!t || !t.dataset || !t.dataset.action) return;

      const action = t.dataset.action;
      const empKey = t.dataset.emp;
      const dayKey = t.dataset.day;
      if (!empKey || !dayKey) return;

      // בדיקת הרשאות
      if (!canEdit(empKey)) {
        alert("אין לך הרשאה לערוך את השורה הזו");
        return;
      }

      const weekData = ensureWeekData();
      const cell = weekData[empKey][dayKey];

      if (action === "type") {
        const value = t.value || "";
        cell.type = value;

        if (value !== "other") {
          cell.other = "";
          clearOtherDebounce(empKey, dayKey);
        }

        saveCell(empKey, dayKey);
        return;
      }

      if (action === "other") {
        cell.other = t.value || "";
        setOtherDebounce(empKey, dayKey, () => saveCell(empKey, dayKey), 500);
        return;
      }
    }

    // =====================================================
    // אתחול
    // =====================================================
    async function init() {
      if (!initCurrentUser()) {
        return; // יועבר לדף הבחירה
      }

      updateCurrentDate();
      updateWeekTitle();
      updateHeaders();

      const tbody = document.getElementById("scheduleBody");
      tbody.addEventListener("change", onTableChange);
      tbody.addEventListener("input", onTableChange);

      document.getElementById("btnPrev").addEventListener("click", async () => {
        currentWeekOffset -= 1;
        updateWeekTitle();
        updateHeaders();
        await loadWeekFromServer();
        renderTable();
      });

      document.getElementById("btnNext").addEventListener("click", async () => {
        currentWeekOffset += 1;
        updateWeekTitle();
        updateHeaders();
        await loadWeekFromServer();
        renderTable();
      });

      document.getElementById("btnRefresh").addEventListener("click", async () => {
        await loadWeekFromServer();
        renderTable();
      });

      await loadWeekFromServer();
      renderTable();
    }

    window.onload = init;
  </script>
</body>
</html>
