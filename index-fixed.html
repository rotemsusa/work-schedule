<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¡×™×“×•×¨ ×¢×‘×•×“×” ×©×‘×•×¢×™</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0;
      max-width: 100%;
    }
    
    html {
      overflow-x: hidden;
      width: 100%;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #2d3748;
      min-height: 100vh;
      padding: 20px 10px;
      color: #1a202c;
      overflow-x: hidden;
      max-width: 100vw;
    }

    /* ========== Login Screen ========== */
    .login-container {
      max-width: 420px;
      margin: 60px auto;
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .login-container h1 { 
      text-align: center; 
      color: #1a202c; 
      margin-bottom: 8px;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .login-container .subtitle { 
      text-align: center; 
      color: #718096; 
      margin-bottom: 32px;
      font-size: 14px;
    }
    
    .demo-badge {
      background: linear-gradient(135deg, #F59E0B, #F97316);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .form-group { 
      margin-bottom: 24px; 
    }
    
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #1a202c;
      font-size: 14px;
    }
    
    .form-group select, 
    .form-group input {
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #e2e8f0; 
      border-radius: 12px; 
      font-size: 15px;
      transition: all 0.2s ease;
      background: white;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .checkbox-group { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 20px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 12px;
    }
    
    .checkbox-group input[type="checkbox"] { 
      width: 20px; 
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }
    
    .password-field { 
      display: none; 
    }
    
    .password-field.show { 
      display: block; 
    }
    
    .btn {
      width: 100%; 
      padding: 14px; 
      border: none; 
      border-radius: 12px;
      font-size: 16px; 
      font-weight: 600; 
      cursor: pointer; 
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .error-msg { 
      color: #E53E3E; 
      text-align: center; 
      margin-top: 16px; 
      display: none;
      font-size: 14px;
    }

    /* ========== App Container ========== */
    .app-container { 
      display: none; 
      max-width: 1200px; 
      margin: 0 auto;
      overflow-x: hidden;
    }
    
    .app-container.active { 
      display: block; 
      animation: fadeIn 0.4s ease;
    }
    
    /* ========== Header ========== */
    .header {
      background: white;
      border-radius: 16px; 
      padding: 16px 20px;
      margin-bottom: 12px; 
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      max-width: 100%;
      overflow-x: hidden;
    }
    
    .header-top { 
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px;
      width: 100%;
      max-width: 100%;
      flex-wrap: wrap;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .cbs-logo {
      height: 40px;
      width: auto;
    }
    
    .header h1 { 
      font-size: 16px; 
      color: #1a202c;
      font-weight: 700;
      margin: 0;
      white-space: nowrap;
    }
    
    .user-name {
      font-weight: 600;
      color: #1a202c;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .header-divider {
      color: #cbd5e0;
      font-size: 14px;
      font-weight: 300;
    }
    
    .user-badge {
      padding: 3px 8px; 
      border-radius: 5px; 
      font-size: 11px; 
      font-weight: 600; 
      color: white;
      white-space: nowrap;
      display: inline-block;
    }
    
    .logout-btn {
      padding: 4px 10px !important;
      font-size: 12px !important;
      background: #f8f9fa !important;
      color: #495057 !important;
      border-radius: 6px !important;
      white-space: nowrap;
    }
    
    .logout-btn:hover {
      background: #e9ecef !important;
      color: #1a202c !important;
    }
    
    .user-name {
      font-weight: 600;
      color: #1a202c;
      font-size: 16px;
    }
    
    .user-badge {
      padding: 4px 10px; 
      border-radius: 6px; 
      font-size: 11px; 
      font-weight: 600; 
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    
    .user-badge.employee { 
      background: linear-gradient(135deg, #3B82F6, #2563EB); 
    }
    
    .user-badge.manager { 
      background: linear-gradient(135deg, #EF4444, #DC2626); 
    }
    
    .user-badge.admin { 
      background: linear-gradient(135deg, #8B5CF6, #7C3AED); 
    }
    
    /* ========== Status Bar ========== */
    .status { 
      margin-top: 16px; 
      padding: 10px; 
      border-radius: 8px; 
      text-align: center; 
      font-size: 14px;
      font-weight: 500;
      color: transparent;
      transition: all 0.3s ease;
    }
    
    .status.saving { 
      background: #FEF3C7; 
      color: #92400E; 
    }
    
    .status.saved { 
      background: #D1FAE5; 
      color: #065F46; 
    }
    
    .status.error { 
      background: #FEE2E2; 
      color: #991B1B; 
    }
    
    /* ========== Week Navigation ========== */
    .week-nav { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 20px; 
      margin: 20px 0; 
      flex-wrap: wrap;
    }
    
    .week-nav button { 
      padding: 10px 20px; 
      font-size: 14px;
      background: white;
      color: #1a202c;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .week-nav button:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }
    
    .week-nav #weekTitle { 
      font-weight: 700; 
      font-size: 16px;
      color: white;
      min-width: 200px;
      text-align: center;
    }
    
    /* ========== Week Table ========== */
    .week-table-container { 
      background: white;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
    }
    
    .week-table { 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0;
      min-width: 600px;
    }
    
    .week-table th { 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white; 
      padding: 12px 8px; 
      text-align: center; 
      font-weight: 600;
      font-size: 14px;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    .week-table th:first-child {
      border-top-right-radius: 12px;
    }
    
    .week-table th:last-child {
      border-top-left-radius: 12px;
    }
    
    .week-table td { 
      padding: 10px 8px; 
      border-bottom: 1px solid #e2e8f0; 
      text-align: center;
      vertical-align: middle;
    }
    
    .week-table tr:last-child td {
      border-bottom: none;
    }
    
    .week-table td:first-child { 
      font-weight: 700; 
      background: #f8f9fa; 
      text-align: right;
      padding-right: 16px;
      color: #1a202c;
      white-space: nowrap;
    }
    
    .week-table select {
      width: 100%;
      max-width: 150px;
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .week-table select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .week-table select[data-color="office"] {
      background: #E3F2FD;
      border-color: #2196F3;
      color: #1565C0;
    }
    
    .week-table select[data-color="home1"] {
      background: #FFF3E0;
      border-color: #FF9800;
      color: #E65100;
    }
    
    .week-table select[data-color="home2"] {
      background: #FFE0B2;
      border-color: #FF5722;
      color: #BF360C;
    }
    
    .week-table select[data-color="vacation"] {
      background: #E8F5E9;
      border-color: #4CAF50;
      color: #2E7D32;
    }
    
    .week-table select[data-color="other"] {
      background: #F3E5F5;
      border-color: #9C27B0;
      color: #6A1B9A;
    }
    
    .other-input {
      margin-top: 8px;
      padding: 8px;
      width: 100%;
      max-width: 150px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .other-input:focus {
      outline: none;
      border-color: #9C27B0;
    }
    
    .day-header {
      font-size: 11px;
      font-weight: 500;
      opacity: 0.9;
      display: block;
      margin-top: 4px;
    }
    
    /* ========== Loading ========== */
    .loading-overlay { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .loading-overlay.show { 
      display: flex; 
    }
    
    .loading-spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #667eea; 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }
    
    /* ========== Admin Modal ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-content h2 {
      margin-bottom: 24px;
      color: #1a202c;
      font-size: 24px;
    }
    
    .employee-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .employee-item input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .employee-item input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-delete {
      padding: 10px 16px;
      background: #FEE2E2;
      color: #991B1B;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .btn-delete:hover {
      background: #FEF2F2;
      transform: translateY(-1px);
    }
    
    .btn-add {
      width: 100%;
      padding: 12px;
      background: #E0E7FF;
      color: #4338CA;
      border: 2px dashed #A5B4FC;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      margin: 16px 0;
      transition: all 0.2s ease;
    }
    
    .btn-add:hover {
      background: #EEF2FF;
      border-color: #818CF8;
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-cancel {
      background: #f8f9fa;
      color: #495057;
    }
    
    .btn-cancel:hover {
      background: #e9ecef;
    }
    
    /* ========== Action Buttons ========== */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .action-buttons button {
      padding: 10px 20px;
      background: white;
      color: #1a202c;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .action-buttons button:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
      transform: translateY(-1px);
    }
    
    .admin-btn {
      background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
      color: white !important;
      border: none !important;
    }
    
    .admin-btn:hover {
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    /* ========== Responsive ========== */
    @media (max-width: 768px) {
      body {
        padding: 10px 5px;
      }
      
      .login-container {
        margin: 20px auto;
        padding: 30px 20px;
      }
      
      .header-top {
        flex-direction: column;
        gap: 10px;
      }
      
      .week-nav {
        flex-direction: column;
        gap: 10px;
      }
      
      .week-nav button,
      .week-nav #weekTitle {
        width: 100%;
      }
      
      .week-table {
        font-size: 12px;
      }
      
      .week-table th,
      .week-table td {
        padding: 8px 4px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons button {
        width: 100%;
      }
      
      .modal-content {
        padding: 20px;
        max-height: 90vh;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="loginContainer">
    <h1>ğŸ” ×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</h1>
    <p class="subtitle">×‘×—×¨ ×¢×•×‘×“ ×•×”×ª×—×‘×¨ ×œ×¡×™×“×•×¨ ×”×¢×‘×•×“×”</p>
    
    <div class="demo-badge">
      ğŸ¯ ××¦×‘ ×”×“×’××” - ×œ×œ× ×¦×•×¨×š ×‘×¡×™×¡××”
    </div>
    
    <form id="loginForm">
      <div class="form-group">
        <label for="employeeSelect">×‘×—×¨ ×¢×•×‘×“:</label>
        <select id="employeeSelect" required>
          <option value="">-- ×‘×—×¨ ×¢×•×‘×“ --</option>
        </select>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="managerMode">
        <label for="managerMode">×”×ª×—×‘×¨×•×ª ×›×× ×”×œ/××“××™×Ÿ</label>
      </div>
      
      <div class="form-group password-field" id="passwordField">
        <label for="passwordInput">×¡×™×¡××”:</label>
        <input type="password" id="passwordInput" placeholder="×”×›× ×¡ ×¡×™×¡××”">
      </div>
      
      <button type="submit" class="btn">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
      <div class="error-msg" id="errorMsg">×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×</div>
    </form>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <h1>ğŸ“… ×¡×™×“×•×¨ ×¢×‘×•×“×” ×©×‘×•×¢×™</h1>
        <div class="header-right">
          <span class="user-name" id="userName"></span>
          <span class="header-divider">|</span>
          <span class="user-badge" id="userBadge"></span>
          <button class="btn logout-btn" onclick="logout()">×™×¦×™××”</button>
        </div>
      </div>
      <div class="status" id="status"></div>
    </div>

    <!-- Week Navigation -->
    <div class="week-nav">
      <button onclick="changeWeek(-1)">â† ×©×‘×•×¢ ×§×•×“×</button>
      <div id="weekTitle"></div>
      <button onclick="changeWeek(1)">×©×‘×•×¢ ×”×‘× â†’</button>
    </div>

    <!-- Week Table -->
    <div class="week-table-container">
      <table class="week-table">
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button id="adminBtn" onclick="openAdminModal()" style="display:none;" class="admin-btn">
        âš™ï¸ × ×™×”×•×œ ×¢×•×‘×“×™×
      </button>
      <button onclick="downloadAsImage()">ğŸ“¥ ×”×•×¨×“×” ×›×ª××•× ×”</button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Admin Modal -->
  <div class="modal-overlay" id="adminModal">
    <div class="modal-content">
      <h2>× ×™×”×•×œ ×¢×•×‘×“×™×</h2>
      <div id="employeeList"></div>
      <button class="btn-add" onclick="addEmployeeRow()">+ ×”×•×¡×£ ×¢×•×‘×“</button>
      <div class="modal-buttons">
        <button class="btn-save" onclick="saveEmployeesToServer()">×©××•×¨</button>
        <button class="btn-cancel" onclick="closeAdminModal()">×‘×™×˜×•×œ</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ========== ×ª×¦×•×¨×” ==========
    const API_URL = "https://script.google.com/macros/s/AKfycbz6NJzSnvZzojzFJDzZlCHbJ_dUFr8qhFkqGkCsLJNBxYFvcwCCiZ9gNQaQCcE_KRty/exec";
    const DAYS = ["sunday", "monday", "tuesday", "wednesday", "thursday"];
    const DAY_NAMES_HE = {
      sunday: "×™×•× ×'",
      monday: "×™×•× ×‘'",
      tuesday: "×™×•× ×’'",
      wednesday: "×™×•× ×“'",
      thursday: "×™×•× ×”'"
    };
    
    let EMPLOYEES = {};
    let weekData = {};
    let currentUser = null;
    let currentWeekOffset = 0;
    
    // ========== ××œ×× ×˜×™× ==========
    const $ = id => document.getElementById(id);
    const loginContainer = $("loginContainer");
    const appContainer = $("appContainer");
    const employeeSelect = $("employeeSelect");
    const managerMode = $("managerMode");
    const passwordField = $("passwordField");
    const passwordInput = $("passwordInput");
    const loginForm = $("loginForm");
    const errorMsg = $("errorMsg");
    const userName = $("userName");
    const userBadge = $("userBadge");
    const tableHeader = $("tableHeader");
    const tableBody = $("tableBody");
    const weekTitle = $("weekTitle");
    const statusEl = $("status");
    const loadingEl = $("loadingOverlay");
    const adminBtn = $("adminBtn");
    const adminModal = $("adminModal");
    
    // ========== ××ª×—×•×œ ==========
    async function init() {
      showLoading(true);
      
      // ×‘×“×™×§×ª ××©×ª××© ×©××•×¨
      const savedUser = localStorage.getItem("schedule_user");
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
        } catch (e) {
          localStorage.removeItem("schedule_user");
        }
      }
      
      // ×˜×¢×™× ×ª ×¢×•×‘×“×™×
      await loadEmployees();
      
      if (currentUser && EMPLOYEES[currentUser.key]) {
        showApp();
      } else {
        showLoading(false);
      }
    }
    
    // ========== ×˜×¢×™× ×ª ×¢×•×‘×“×™× ××”×©×¨×ª ==========
    async function loadEmployees() {
      try {
        const response = await fetch(`${API_URL}?action=getEmployees`);
        const data = await response.json();
        
        if (data.success && data.employees) {
          EMPLOYEES = data.employees;
          populateEmployeeSelect();
        }
      } catch (e) {
        console.error("Error loading employees:", e);
      }
    }
    
    // ========== ××™×œ×•×™ ×¨×©×™××ª ×”×¢×•×‘×“×™× ×‘×˜×•×¤×¡ ==========
    function populateEmployeeSelect() {
      employeeSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¢×•×‘×“ --</option>';
      Object.keys(EMPLOYEES).forEach(key => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = EMPLOYEES[key];
        employeeSelect.appendChild(option);
      });
    }
    
    // ========== ×”×ª×—×‘×¨×•×ª ==========
    managerMode.addEventListener("change", () => {
      passwordField.classList.toggle("show", managerMode.checked);
      if (!managerMode.checked) passwordInput.value = "";
    });
    
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const empKey = employeeSelect.value;
      const isManager = managerMode.checked;
      const password = passwordInput.value;
      
      if (!empKey) {
        errorMsg.textContent = "×™×© ×œ×‘×—×•×¨ ×¢×•×‘×“";
        errorMsg.style.display = "block";
        return;
      }
      
      let role = "employee";
      if (isManager) {
        if (password === "admin123") {
          role = "admin";
        } else if (password === "manager123") {
          role = "manager";
        } else {
          errorMsg.textContent = "×¡×™×¡××” ×©×’×•×™×”";
          errorMsg.style.display = "block";
          return;
        }
      }
      
      currentUser = {
        key: empKey,
        name: EMPLOYEES[empKey],
        role: role
      };
      
      localStorage.setItem("schedule_user", JSON.stringify(currentUser));
      showApp();
    });
    
    // ========== ×”×¦×’×ª ×”××¤×œ×™×§×¦×™×” ==========
    function showApp() {
      loginContainer.style.display = "none";
      appContainer.classList.add("active");
      
      userName.textContent = currentUser.name;
      userBadge.textContent = currentUser.role === "admin" ? "××“××™×Ÿ" : 
                              currentUser.role === "manager" ? "×× ×”×œ" : "×¢×•×‘×“";
      userBadge.className = "user-badge " + currentUser.role;
      
      if (currentUser.role === "admin") {
        adminBtn.style.display = "inline-block";
      }
      
      buildTable();
      loadWeekData();
      showLoading(false);
    }
    
    // ========== ×™×¦×™××” ==========
    function logout() {
      localStorage.removeItem("schedule_user");
      currentUser = null;
      appContainer.classList.remove("active");
      loginContainer.style.display = "block";
      errorMsg.style.display = "none";
      employeeSelect.value = "";
      managerMode.checked = false;
      passwordField.classList.remove("show");
      passwordInput.value = "";
    }
    
    // ========== ×‘× ×™×™×ª ×”×˜×‘×œ×” ==========
    function buildTable() {
      const dates = getWeekDates(currentWeekOffset);
      const weekKey = getWeekKey(currentWeekOffset);
      weekTitle.textContent = `×©×‘×•×¢ ${weekKey}`;
      
      // ×‘× ×™×™×ª ×›×•×ª×¨×ª
      tableHeader.innerHTML = "<th>×¢×•×‘×“</th>";
      DAYS.forEach((day, i) => {
        const th = document.createElement("th");
        th.innerHTML = `${DAY_NAMES_HE[day]}<br><span class="day-header">${formatDate(dates[i])}</span>`;
        tableHeader.appendChild(th);
      });
      
      // ×‘× ×™×™×ª ×©×•×¨×•×ª
      tableBody.innerHTML = "";
      Object.keys(EMPLOYEES).forEach(empKey => {
        const tr = document.createElement("tr");
        
        const tdName = document.createElement("td");
        tdName.textContent = EMPLOYEES[empKey];
        tr.appendChild(tdName);
        
        DAYS.forEach(day => {
          const td = document.createElement("td");
          const select = document.createElement("select");
          select.dataset.emp = empKey;
          select.dataset.day = day;
          
          const canEdit = currentUser.role === "admin" || 
                         currentUser.role === "manager" || 
                         currentUser.key === empKey;
          
          select.disabled = !canEdit;
          
          select.innerHTML = `
            <option value="">--</option>
            <option value="office">××©×¨×“</option>
            <option value="home1">×‘×™×ª 1</option>
            <option value="home2">×‘×™×ª 2</option>
            <option value="vacation">×—×•×¤×©</option>
            <option value="other">××—×¨...</option>
          `;
          
          select.addEventListener("change", (e) => handleCellChange(e, empKey, day));
          td.appendChild(select);
          tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
      });
    }
    
    // ========== ×¢×–×¨×™× ×œ×ª××¨×™×›×™× ==========
    function getWeekKey(offset) {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const diff = dayOfWeek === 6 ? 1 : (dayOfWeek === 0 ? -6 : 1 - dayOfWeek);
      
      const sunday = new Date(now);
      sunday.setDate(now.getDate() + diff + (offset * 7));
      
      const year = sunday.getFullYear();
      const month = String(sunday.getMonth() + 1).padStart(2, "0");
      const day = String(sunday.getDate()).padStart(2, "0");
      
      return `${year}-${month}-${day}`;
    }
    
    function getWeekDates(offset) {
      const weekKey = getWeekKey(offset);
      const [year, month, day] = weekKey.split("-").map(Number);
      const sunday = new Date(year, month - 1, day);
      
      const dates = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(sunday);
        d.setDate(sunday.getDate() + i);
        dates.push(d);
      }
      return dates;
    }
    
    function formatDate(date) {
      const d = String(date.getDate()).padStart(2, "0");
      const m = String(date.getMonth() + 1).padStart(2, "0");
      return `${d}/${m}`;
    }
    
    function changeWeek(offset) {
      currentWeekOffset += offset;
      buildTable();
      loadWeekData();
    }
    
    // ========== ×˜×¢×™× ×ª × ×ª×•× ×™ ×©×‘×•×¢ ==========
    async function loadWeekData() {
      const weekKey = getWeekKey(currentWeekOffset);
      showLoading(true);
      
      try {
        const response = await fetch(`${API_URL}?action=getWeek&week_key=${weekKey}`);
        const data = await response.json();
        
        if (data.success && data.data) {
          weekData = {};
          
          data.data.forEach(row => {
            const empKey = row.employee_key;
            const dayKey = row.day_key;
            
            if (!weekData[empKey]) weekData[empKey] = {};
            weekData[empKey][dayKey] = row.choice_value;
            weekData[empKey][dayKey + "_other"] = row.choice_other || "";
          });
          
          renderWeekData();
        }
      } catch (e) {
        console.error("Error loading week:", e);
      }
      
      showLoading(false);
    }
    
    // ========== ×¢×“×›×•×Ÿ ×××©×§ ==========
    function renderWeekData() {
      Object.keys(EMPLOYEES).forEach(empKey => {
        DAYS.forEach(day => {
          const select = tableBody.querySelector(`select[data-emp="${empKey}"][data-day="${day}"]`);
          if (!select) return;
          
          const value = (weekData[empKey] && weekData[empKey][day]) || "";
          const otherText = (weekData[empKey] && weekData[empKey][day + "_other"]) || "";
          
          select.value = value;
          select.dataset.color = value || "";
          
          const existingNote = select.parentElement.querySelector(".other-input");
          if (existingNote) existingNote.remove();
          
          if (value === "other") {
            const input = document.createElement("input");
            input.type = "text";
            input.className = "other-input";
            input.placeholder = "×”×›× ×¡ ×¤×™×¨×•×˜...";
            input.value = otherText;
            input.disabled = select.disabled;
            input.addEventListener("blur", (e) => handleOtherChange(e, empKey, day));
            select.parentElement.appendChild(input);
          }
        });
      });
    }
    
    // ========== ×˜×™×¤×•×œ ×‘×©×™× ×•×™×™× ==========
    async function handleCellChange(e, empKey, day) {
      const select = e.target;
      const value = select.value;
      
      select.dataset.color = value || "";
      
      if (!weekData[empKey]) weekData[empKey] = {};
      weekData[empKey][day] = value;
      
      const existingNote = select.parentElement.querySelector(".other-input");
      
      if (value === "other" && !existingNote) {
        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.className = "other-input";
        noteInput.placeholder = "×”×›× ×¡ ×¤×™×¨×•×˜...";
        noteInput.disabled = select.disabled;
        noteInput.addEventListener("blur", (e) => handleOtherChange(e, empKey, day));
        select.parentElement.appendChild(noteInput);
        noteInput.focus();
      } else if (value !== "other" && existingNote) {
        let stillHasOther = false;
        DAYS.forEach(d => {
          if (weekData[empKey][d] === "other") stillHasOther = true;
        });
        if (!stillHasOther) {
          existingNote.remove();
        }
      }
      
      showStatus("saving", "×©×•××¨...");
      
      // ×©××™×¨×” ×œ×©×¨×ª
      await saveToServer(empKey, day, value, weekData[empKey][day + "_other"] || "");
    }
    
    async function handleOtherChange(e, empKey, day) {
      const input = e.target;
      const value = input.value;
      
      if (!weekData[empKey]) weekData[empKey] = {};
      weekData[empKey][day + "_other"] = value;
      
      showStatus("saving", "×©×•××¨...");
      
      await saveToServer(empKey, day, weekData[empKey][day], value);
    }
    
    async function saveToServer(empKey, day, choiceValue, choiceOther) {
      const weekKey = getWeekKey(currentWeekOffset);
      
      try {
        const payload = {
          employee_key: empKey,
          employee_name: EMPLOYEES[empKey],
          week_key: weekKey,
          day_key: day,
          choice_value: choiceValue,
          choice_other: choiceOther,
          updated_by: currentUser.key,
          updated_by_name: currentUser.name
        };
        
        const response = await fetch(`${API_URL}?action=upsertCell`, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        if (data.success) {
          showStatus("saved", "× ×©××¨ âœ“");
        } else {
          showStatus("error", "×©×’×™××” ×‘×©××™×¨×”");
        }
      } catch (e) {
        showStatus("error", "×©×’×™××” ×‘×©××™×¨×”");
      }
    }

    // ========== Admin Modal ==========
    function openAdminModal() {
      const list = $("employeeList");
      list.innerHTML = "";
      
      Object.keys(EMPLOYEES).forEach(key => {
        addEmployeeRowToModal(key, EMPLOYEES[key]);
      });
      
      adminModal.classList.add("show");
    }

    function closeAdminModal() {
      adminModal.classList.remove("show");
    }

    function addEmployeeRow() {
      const newKey = "emp" + Date.now();
      addEmployeeRowToModal(newKey, "");
    }

    function addEmployeeRowToModal(key, name) {
      const list = $("employeeList");
      const div = document.createElement("div");
      div.className = "employee-item";
      div.dataset.key = key;
      div.innerHTML = `
        <input type="text" value="${name}" placeholder="×©× ×”×¢×•×‘×“">
        <button class="btn-delete" onclick="this.parentElement.remove()">××—×§</button>
      `;
      list.appendChild(div);
    }

    async function saveEmployeesToServer() {
      const items = $("employeeList").querySelectorAll(".employee-item");
      const newEmployees = {};
      
      items.forEach(item => {
        const key = item.dataset.key;
        const name = item.querySelector("input").value.trim();
        if (name) {
          newEmployees[key] = name;
        }
      });
      
      showStatus("saving", "×©×•××¨...");
      
      try {
        const response = await fetch(`${API_URL}?action=saveEmployees`, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ employees: newEmployees })
        });
        
        const data = await response.json();
        if (data.success) {
          // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×¢×•×‘×“×™×
          EMPLOYEES = newEmployees;
          
          // ×¢×“×›×•×Ÿ ×”×¡×œ×§×˜ ×‘×˜×•×¤×¡ ×”×”×ª×—×‘×¨×•×ª
          populateEmployeeSelect();
          
          // ×¡×’×™×¨×ª ×”××•×“×œ - ğŸ”§ ×ª×™×§×•×Ÿ: ×–×” ×§×•×¨×” ×ª××™×“ ×× ×”×©××™×¨×” ×”×¦×œ×™×—×”
          closeAdminModal();
          
          // ×¢×“×›×•×Ÿ ×©× ×”××©×ª××© ×”× ×•×›×—×™ ×× ×”×•× ×‘×¢×“×™×™×Ÿ ×‘×¨×©×™××”
          if (EMPLOYEES[currentUser.key]) {
            currentUser.name = EMPLOYEES[currentUser.key];
            userName.textContent = currentUser.name;
            localStorage.setItem("schedule_user", JSON.stringify(currentUser));
          }
          
          // ×‘× ×™×™×” ××—×“×© ×©×œ ×”×˜×‘×œ×” ×¢× ×”×¢×•×‘×“×™× ×”××¢×•×“×›× ×™×
          buildTable();
          
          // ×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××—×“×©
          loadWeekData();
          
          showStatus("saved", "× ×©××¨ âœ“");
        } else {
          showStatus("error", "×©×’×™××” ×‘×©××™×¨×”");
        }
      } catch (e) {
        console.error("Error saving employees:", e);
        showStatus("error", "×©×’×™××” ×‘×©××™×¨×”");
      }
    }

    // ========== ×¢×–×¨ ==========
    function showStatus(type, text) {
      statusEl.textContent = text;
      statusEl.className = "status " + type;
      
      if (type !== "saving") {
        setTimeout(() => {
          statusEl.className = "status";
        }, 3000);
      }
    }
    
    function showLoading(show) {
      loadingEl.classList.toggle("show", show);
    }

    // ========== ×”×•×¨×“×ª ×ª××•× ×” ==========
    async function downloadAsImage() {
      if (typeof html2canvas === 'undefined') {
        alert("×˜×•×¢×Ÿ... × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”");
        return;
      }
      
      showStatus("saving", "××›×™×Ÿ ×ª××•× ×”...");
      
      const weekKey = getWeekKey(currentWeekOffset);
      const dates = getWeekDates(currentWeekOffset);
      
      const container = document.createElement("div");
      container.style.cssText = "position: fixed; top: -9999px; left: -9999px; background: white; padding: 20px; border-radius: 15px; direction: rtl; font-family: Arial, sans-serif; min-width: 400px;";
      
      const title = document.createElement("div");
      title.style.cssText = "text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 15px; color: #2c3e50;";
      title.textContent = "ğŸ“… ×¡×™×“×•×¨ ×¢×‘×•×“×” - " + weekTitle.textContent;
      container.appendChild(title);
      
      const legend = document.createElement("div");
      legend.style.cssText = "display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;";
      legend.innerHTML = `
        <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:20px;background:#2196f3;border-radius:5px;display:inline-block;"></span> ××©×¨×“</span>
        <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:20px;background:#ff9800;border-radius:5px;display:inline-block;"></span> ×‘×™×ª 1</span>
        <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:20px;background:#ff5722;border-radius:5px;display:inline-block;"></span> ×‘×™×ª 2</span>
        <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:20px;background:#4caf50;border-radius:5px;display:inline-block;"></span> ×—×•×¤×©</span>
        <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:20px;background:#9c27b0;border-radius:5px;display:inline-block;"></span> ××—×¨</span>
      `;
      container.appendChild(legend);
      
      const table = document.createElement("table");
      table.style.cssText = "width: 100%; border-collapse: collapse;";
      
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["×¢×•×‘×“", "×'", "×‘'", "×’'", "×“'", "×”'"].forEach((h, i) => {
        const th = document.createElement("th");
        th.style.cssText = "background: #667eea; color: white; padding: 10px; border: 1px solid #ddd;";
        if (i > 0) {
          th.innerHTML = h + "<br><small>" + formatDate(dates[i-1]) + "</small>";
        } else {
          th.textContent = h;
        }
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      const tbody = document.createElement("tbody");
      Object.keys(EMPLOYEES).forEach(empKey => {
        const tr = document.createElement("tr");
        
        const tdName = document.createElement("td");
        tdName.textContent = EMPLOYEES[empKey];
        tdName.style.cssText = "font-weight: bold; padding: 10px; border: 1px solid #ddd; background: #f8f9fa;";
        tr.appendChild(tdName);
        
        DAYS.forEach(day => {
          const td = document.createElement("td");
          td.style.cssText = "padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;";
          
          const value = (weekData[empKey] && weekData[empKey][day]) || "";
          const otherText = (weekData[empKey] && weekData[empKey][day + "_other"]) || "";
          
          if (value === "office") {
            td.style.background = "#2196f3";
            td.style.color = "white";
          } else if (value === "home1") {
            td.style.background = "#ff9800";
            td.style.color = "white";
          } else if (value === "home2") {
            td.style.background = "#ff5722";
            td.style.color = "white";
          } else if (value === "vacation") {
            td.style.background = "#4caf50";
            td.style.color = "white";
          } else if (value === "other") {
            td.style.background = "#9c27b0";
            td.style.color = "white";
            td.textContent = otherText || "××—×¨";
          } else {
            td.style.background = "#e0e0e0";
            td.style.color = "#999";
          }
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      container.appendChild(table);
      
      const footer = document.createElement("div");
      footer.style.cssText = "text-align: center; font-size: 12px; color: #7f8c8d; margin-top: 15px;";
      footer.textContent = "×”×•×¤×§: " + new Date().toLocaleDateString("he-IL") + " " + new Date().toLocaleTimeString("he-IL");
      container.appendChild(footer);
      
      document.body.appendChild(container);
      
      try {
        const canvas = await html2canvas(container, { scale: 2, backgroundColor: "#ffffff" });
        const link = document.createElement("a");
        link.download = "×¡×™×“×•×¨_×¢×‘×•×“×”_" + weekKey.replace(/-/g, "_") + ".png";
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showStatus("saved", "×”×ª××•× ×” ×”×•×¨×“×” âœ“");
      } catch (e) {
        console.error(e);
        showStatus("error", "×©×’×™××” ×‘×”×•×¨×“×ª ×”×ª××•× ×”");
      }
      
      document.body.removeChild(container);
    }

    // ========== ×”×ª×—×œ×” ==========
    init();
  </script>
</body>
</html>
